# Procurator 项目说明文档

## 1. 项目简介

**Procurator** 是一个企业级的异步任务网关与执行系统。它旨在解决微服务架构中"任务分发"与"任务执行"的耦合问题，提供统一的鉴权、流控、重试和监控机制。

核心设计理念是 **"Flow in Redis, State in DB"** —— 使用 Redis Stream 处理高并发的任务流转，使用关系型数据库（PostgreSQL/SQLite）存储持久化的任务状态和审计日志。

## 2. 核心架构

### 2.1 技术栈
- **Web 框架**: FastAPI (Python 3.11+)
- **ORM**: SQLAlchemy 2.0 (Async)
- **队列后端**: Redis Stream (支持 Consumer Group 消费模式)
- **数据库**: PostgreSQL (生产推荐) / SQLite (开发默认)
- **监控**: Prometheus (Metrics) + Loki (Logs) + Grafana

### 2.2 模块划分
```
app/
├── core/           # 核心配置 (Config, Security, Database, Redis)
├── infra/          # 基础设施 (RateLimiter, FeishuClient, Webhook)
├── models/         # 数据库模型 (Task, User, System)
├── queues/         # 队列逻辑 (QueueManager, RedisBackend)
├── routers/        # API 路由 (Logs, DLQ)
├── services/       # 业务逻辑 (Auth, System, Demo)
├── worker.py       # 消费者进程入口
└── main.py         # API 服务入口
```

## 3. 功能特性详解

### 3.1 鉴权体系 (RBAC)
系统实现了基于数据库的 RBAC 权限控制：
- **API Token**: 客户端通过 `X-API-Token` 请求头进行认证。
- **动态管理**: 所有的 Token 存储在数据库 `users` 表中，存储的是 Hash 值，保障安全。
- **角色控制**: 支持 `admin` (全权限), `ops` (运维), `dev` (开发者) 等角色。

### 3.2 队列与可靠性
- **Redis Stream**: 使用 Consumer Group 模式，支持多 Worker 负载均衡。
- **ACK 机制**: 只有任务执行成功或明确失败后才会 ACK，防止任务丢失。
- **Crash Recovery**: Worker 启动时会自动扫描长时间 Pending 的消息（通过 `XPENDING` + `XCLAIM`）并重新执行，确保服务重启不丢单。
- **死信队列 (DLQ)**: 超过最大重试次数的任务会被移入 DLQ，并记录原始 Payload 供后续排查或重放。

### 3.3 可观测性
- **日志**: 集成 Promtail + Loki，支持通过 Grafana 进行实时日志检索和关键词过滤。
- **指标**: 提供 `/metrics` 接口，暴露任务吞吐量、队列堆积数、执行耗时等 Prometheus 指标。

## 4. 部署与配置

### 4.1 环境变量 (.env)
| 变量名 | 默认值 | 说明 |
| :--- | :--- | :--- |
| `SERVER_PORT` | `50002` | 服务监听端口 |
| `DATABASE_URL` | `sqlite+aiosqlite:///./app.db` | 数据库连接串 |
| `QUEUE_BACKEND` | `memory` | 队列模式：`redis` (生产) 或 `memory` (开发) |
| `REDIS_URL` | `redis://localhost:6379/0` | Redis 地址 |
| `API_TOKENS` | `{}` | **(已弃用)** 旧版静态 Token 配置，仅作为 Fallback |

### 4.2 初始化流程
首次部署请执行以下命令初始化环境：

1. **安装依赖**: `pip install -r requirements.txt`
2. **应用迁移**: `alembic upgrade head` (创建数据库表)
3. **创建管理员**: `python tools/create_admin.py` (生成 API Key)
4. **启动服务**: `python serve.py`

### 4.3 监控部署
项目自带全套监控栈配置，位于 `deploy/monitoring/`：
```bash
docker-compose -f deploy/monitoring/docker-compose.yml up -d
```
启动后访问 `http://localhost:3000` 查看 Grafana 面板。
