# Procurator 对接文档

本文档详细说明了如何调用 Procurator 的 API 接口进行任务分发和系统管理。

## 1. 基础说明

### 1.1 鉴权
所有受保护的接口都需要在 HTTP Header 中携带 API Token：
```http
X-API-Token: <your_api_key>
```
*注：请联系管理员通过 `tools/create_admin.py` 生成新的 Token。*

### 1.2 响应格式
标准响应结构如下：
```json
{
  "code": 200,      // 业务状态码 (非 HTTP 状态码)
  "message": "ok",  // 提示信息
  "data": { ... }   // 业务数据
}
```

## 2. 核心接口

### 2.1 任务分发 (Dispatch)
将任务发送到队列或同步执行。

- **URL**: `POST /dispatch`
- **Auth**: Required
- **Body**:
  ```json
  {
    "task": "system.ping",       // 任务名称 (必填)
    "taskData": {                // 任务参数 (必填)
      "target": "127.0.0.1"
    },
    "queue": "api",              // 指定队列 (默认: api)
    "async": true,               // 是否异步执行 (默认: true)
    "maxRetries": 3,             // 最大重试次数
    "webhook": "http://..."      // 回调地址 (可选)
  }
  ```
- **Response**:
  ```json
  {
    "accepted": true,
    "task_id": "550e8400-e29b-41d4-a716-446655440000"
  }
  ```

### 2.2 查询任务状态
- **URL**: `GET /task/{task_id}`
- **Auth**: Required
- **Response**:
  ```json
  {
    "status": "completed" // pending, processing, completed, failed, dead
  }
  ```

### 2.3 查询任务详情
获取任务的完整执行记录，包括输入参数、执行结果和错误信息。

- **URL**: `GET /task/{task_id}/detail`
- **Auth**: Required

## 3. 管理接口

### 3.1 死信队列 (DLQ) 管理
- **查看队列列表**: `GET /dlq/{queue_name}`
- **查看死信详情**: `GET /dlq/{queue_name}/{msg_id}`
- **重放死信任务**: `POST /dlq/{queue_name}/{msg_id}/replay`
- **清空死信队列**: `DELETE /dlq/{queue_name}` (慎用，需 Admin 权限)

### 3.2 日志查看
- **列出日志文件**: `GET /logs/list`
- **读取日志内容**: `GET /logs/read?filename=api.log&lines=100`

### 3.3 系统监控
- **Prometheus 指标**: `GET /metrics` (无需鉴权，供 Scraper 抓取)
- **健康检查**: `GET /ping`

## 4. 常见错误码

| HTTP Code | 说明 |
| :--- | :--- |
| 401 | **Unauthorized**: Token 无效或缺失 |
| 403 | **Forbidden**: 权限不足 (如 dev 角色尝试操作 DLQ) |
| 422 | **Validation Error**: 参数格式错误 |
| 429 | **Too Many Requests**: 触发流控限制 |
